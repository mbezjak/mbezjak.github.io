<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Configuring SQL Data Source | Well Organized Bits</title><meta name=keywords content><meta name=description content="What are you using to configure an SQL data source? Clojure wrappers? Own abstractions? Plain implementation?
Perhaps you&rsquo;re seeing something weird in production and want to investigate? Do questions such as these come up now and again:
How many concurrent connections does the pool allow? Is this ok time to do RDS snapshot? What happens to existing connections if RDS restarts? How long is the connection timeout? How long is the statement timeout?"><meta name=author content="Miro Bezjak"><link rel=canonical href=https://mbezjak.github.io/posts/configuring-sql-data-source/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mbezjak.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mbezjak.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mbezjak.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://mbezjak.github.io/apple-touch-icon.png><link rel=mask-icon href=https://mbezjak.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Configuring SQL Data Source"><meta property="og:description" content="What are you using to configure an SQL data source? Clojure wrappers? Own abstractions? Plain implementation?
Perhaps you&rsquo;re seeing something weird in production and want to investigate? Do questions such as these come up now and again:
How many concurrent connections does the pool allow? Is this ok time to do RDS snapshot? What happens to existing connections if RDS restarts? How long is the connection timeout? How long is the statement timeout?"><meta property="og:type" content="article"><meta property="og:url" content="https://mbezjak.github.io/posts/configuring-sql-data-source/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-21T10:00:27+01:00"><meta property="article:modified_time" content="2022-11-21T10:00:27+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Configuring SQL Data Source"><meta name=twitter:description content="What are you using to configure an SQL data source? Clojure wrappers? Own abstractions? Plain implementation?
Perhaps you&rsquo;re seeing something weird in production and want to investigate? Do questions such as these come up now and again:
How many concurrent connections does the pool allow? Is this ok time to do RDS snapshot? What happens to existing connections if RDS restarts? How long is the connection timeout? How long is the statement timeout?"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://mbezjak.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Configuring SQL Data Source","item":"https://mbezjak.github.io/posts/configuring-sql-data-source/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Configuring SQL Data Source","name":"Configuring SQL Data Source","description":"What are you using to configure an SQL data source? Clojure wrappers? Own abstractions? Plain implementation?\nPerhaps you\u0026rsquo;re seeing something weird in production and want to investigate? Do questions such as these come up now and again:\nHow many concurrent connections does the pool allow? Is this ok time to do RDS snapshot? What happens to existing connections if RDS restarts? How long is the connection timeout? How long is the statement timeout?","keywords":[],"articleBody":"What are you using to configure an SQL data source? Clojure wrappers? Own abstractions? Plain implementation?\nPerhaps you’re seeing something weird in production and want to investigate? Do questions such as these come up now and again:\nHow many concurrent connections does the pool allow? Is this ok time to do RDS snapshot? What happens to existing connections if RDS restarts? How long is the connection timeout? How long is the statement timeout? How long is the lock timeout? etc. To find the answer, do you have to read and understand:\nconnection pool’s documentation? JDBC driver’s documentation? RDS engine defaults? wrapper’s documentation? wrapper’s source code? Can easy-to-read data source configuration help answer those questions? I find this to be one of those situations where readability and unambiguousness are more important that avoiding the copy and paste of defaults, using wrappers or own abstractions. It doesn’t take much more to configure the data source.\n(ns db-init (:import (com.zaxxer.hikari HikariConfig HikariDataSource))) (defn start [url password] ;; https://github.com/brettwooldridge/HikariCP (let [hc (doto (HikariConfig.) (.setJdbcUrl url) (.setPassword password) (.setAutoCommit true) (.setConnectionTimeout (* 30 1000)) (.setIdleTimeout (* 10 60 1000)) (.setMaxLifetime (* 30 60 1000)) (.setMinimumIdle 3) (.setMaximumPoolSize 10) (.setConnectionInitSql nil) (.setValidationTimeout (* 5 1000)) (.setLeakDetectionThreshold (* 60 1000)) ;; Global postgres timeout settings. If a particular transaction ;; needs different timeouts just execute SQL statements such as: ;; SET LOCAL statement_timout = '30s'; ;; SET LOCAL lock_timout = '30s'; ;; https://jdbc.postgresql.org/documentation/use/ ;; https://www.postgresql.org/docs/11/runtime-config-client.html ;; https://stackoverflow.com/questions/20963450/controlling-duration-of-postgresql-lock-waits (.addDataSourceProperty \"options\" \"-c statement_timeout=60s -c lock_timeout=5s\"))] (HikariDataSource. hc))) Note that the actual configuration is entirely contextual and depends on the service you’re building. E.g. having a lock timeout or large statement timeout might be good enough (even beneficial) for an internal admin service that doesn’t receive a lot of requests. A service with 100 requests per second might need to configure the data source a bit differently.\n","wordCount":"307","inLanguage":"en","datePublished":"2022-11-21T10:00:27+01:00","dateModified":"2022-11-21T10:00:27+01:00","author":{"@type":"Person","name":"Miro Bezjak"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mbezjak.github.io/posts/configuring-sql-data-source/"},"publisher":{"@type":"Organization","name":"Well Organized Bits","logo":{"@type":"ImageObject","url":"https://mbezjak.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mbezjak.github.io accesskey=h title="Well Organized Bits (Alt + H)">Well Organized Bits</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=mailto:well.organized.bits@proton.me title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://mbezjak.github.io>Home</a>&nbsp;»&nbsp;<a href=https://mbezjak.github.io/posts/>Posts</a></div><h1 class=post-title>Configuring SQL Data Source</h1><div class=post-meta><span title='2022-11-21 10:00:27 +0100 +0100'>November 21, 2022</span>&nbsp;·&nbsp;Miro Bezjak&nbsp;|&nbsp;<a href=https://github.com/mbezjak/mbezjak.github.io/blob/main/content/posts/configuring-sql-data-source.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>What are you using to configure an SQL data source? Clojure
<a href=https://github.com/tomekw/hikari-cp>wrappers</a>? Own abstractions? Plain
<a href=https://github.com/brettwooldridge/HikariCP>implementation</a>?</p><p>Perhaps you&rsquo;re seeing something weird in production and want to investigate? Do
questions such as these come up now and again:</p><ul><li>How many concurrent connections does the pool allow?</li><li>Is this ok time to do RDS snapshot?</li><li>What happens to existing connections if RDS restarts?</li><li>How long is the connection timeout?</li><li>How long is the statement timeout?</li><li>How long is the lock timeout?</li><li>etc.</li></ul><p>To find the answer, do you have to read and understand:</p><ul><li>connection pool&rsquo;s documentation?</li><li>JDBC driver&rsquo;s documentation?</li><li>RDS engine defaults?</li><li>wrapper&rsquo;s documentation?</li><li>wrapper&rsquo;s source code?</li></ul><p>Can easy-to-read data source configuration help answer those questions? I find
this to be one of those situations where readability and unambiguousness are
more important that avoiding the copy and paste of defaults, using wrappers or
own abstractions. It doesn&rsquo;t take much more to configure the data source.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#66d9ef>ns </span>db-init
</span></span><span style=display:flex><span>  (<span style=color:#e6db74>:import</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>com.zaxxer.hikari</span> HikariConfig HikariDataSource)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>defn </span>start [url password]
</span></span><span style=display:flex><span>  <span style=color:#75715e>;; https://github.com/brettwooldridge/HikariCP</span>
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>[hc (doto (<span style=color:#a6e22e>HikariConfig.</span>)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setJdbcUrl</span> url)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setPassword</span> password)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setAutoCommit</span> true)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setConnectionTimeout</span> (* <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>1000</span>))
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setIdleTimeout</span> (* <span style=color:#ae81ff>10</span> <span style=color:#ae81ff>60</span> <span style=color:#ae81ff>1000</span>))
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setMaxLifetime</span> (* <span style=color:#ae81ff>30</span> <span style=color:#ae81ff>60</span> <span style=color:#ae81ff>1000</span>))
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setMinimumIdle</span> <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setMaximumPoolSize</span> <span style=color:#ae81ff>10</span>)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setConnectionInitSql</span> nil)
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setValidationTimeout</span> (* <span style=color:#ae81ff>5</span> <span style=color:#ae81ff>1000</span>))
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.setLeakDetectionThreshold</span> (* <span style=color:#ae81ff>60</span> <span style=color:#ae81ff>1000</span>))
</span></span><span style=display:flex><span>             <span style=color:#75715e>;; Global postgres timeout settings. If a particular transaction</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>;; needs different timeouts just execute SQL statements such as:</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>;;    SET LOCAL statement_timout = &#39;30s&#39;;</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>;;    SET LOCAL lock_timout = &#39;30s&#39;;</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>;; https://jdbc.postgresql.org/documentation/use/</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>;; https://www.postgresql.org/docs/11/runtime-config-client.html</span>
</span></span><span style=display:flex><span>             <span style=color:#75715e>;; https://stackoverflow.com/questions/20963450/controlling-duration-of-postgresql-lock-waits</span>
</span></span><span style=display:flex><span>             (<span style=color:#a6e22e>.addDataSourceProperty</span> <span style=color:#e6db74>&#34;options&#34;</span> <span style=color:#e6db74>&#34;-c statement_timeout=60s -c lock_timeout=5s&#34;</span>))]
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>HikariDataSource.</span> hc)))
</span></span></code></pre></div><p>Note that the actual configuration is entirely contextual and depends on the
service you&rsquo;re building. E.g. having a lock timeout or large statement timeout
might be good enough (even beneficial) for an internal admin service that
doesn&rsquo;t receive a lot of requests. A service with 100 requests per second might
need to configure the data source a bit differently.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://mbezjak.github.io>Well Organized Bits</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>