<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Routing Slf4j Events To Mulog | Well Organized Bits</title><meta name=keywords content><meta name=description content="mulog plays to Clojure&rsquo;s strengths such as declaring, using and manipulating data vs. composing and parsing strings. That&rsquo;s why I like using it as a logging library. However, backend services might use other Java libraries that only use what&rsquo;s available in the JVM ecosystem. Best case scenario is that backend ends up using at least two logging libraries: mulog and slf4j. Each one has to be configured to work properly. Even if they are, some questions still remain:"><meta name=author content="Miro Bezjak"><link rel=canonical href=https://mbezjak.github.io/posts/routing-slf4j-events-to-mulog/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mbezjak.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mbezjak.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mbezjak.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://mbezjak.github.io/apple-touch-icon.png><link rel=mask-icon href=https://mbezjak.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Routing Slf4j Events To Mulog"><meta property="og:description" content="mulog plays to Clojure&rsquo;s strengths such as declaring, using and manipulating data vs. composing and parsing strings. That&rsquo;s why I like using it as a logging library. However, backend services might use other Java libraries that only use what&rsquo;s available in the JVM ecosystem. Best case scenario is that backend ends up using at least two logging libraries: mulog and slf4j. Each one has to be configured to work properly. Even if they are, some questions still remain:"><meta property="og:type" content="article"><meta property="og:url" content="https://mbezjak.github.io/posts/routing-slf4j-events-to-mulog/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-10T14:09:01+01:00"><meta property="article:modified_time" content="2022-11-10T14:09:01+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Routing Slf4j Events To Mulog"><meta name=twitter:description content="mulog plays to Clojure&rsquo;s strengths such as declaring, using and manipulating data vs. composing and parsing strings. That&rsquo;s why I like using it as a logging library. However, backend services might use other Java libraries that only use what&rsquo;s available in the JVM ecosystem. Best case scenario is that backend ends up using at least two logging libraries: mulog and slf4j. Each one has to be configured to work properly. Even if they are, some questions still remain:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://mbezjak.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Routing Slf4j Events To Mulog","item":"https://mbezjak.github.io/posts/routing-slf4j-events-to-mulog/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Routing Slf4j Events To Mulog","name":"Routing Slf4j Events To Mulog","description":"mulog plays to Clojure\u0026rsquo;s strengths such as declaring, using and manipulating data vs. composing and parsing strings. That\u0026rsquo;s why I like using it as a logging library. However, backend services might use other Java libraries that only use what\u0026rsquo;s available in the JVM ecosystem. Best case scenario is that backend ends up using at least two logging libraries: mulog and slf4j. Each one has to be configured to work properly. Even if they are, some questions still remain:","keywords":[],"articleBody":"mulog plays to Clojure’s strengths such as declaring, using and manipulating data vs. composing and parsing strings. That’s why I like using it as a logging library. However, backend services might use other Java libraries that only use what’s available in the JVM ecosystem. Best case scenario is that backend ends up using at least two logging libraries: mulog and slf4j. Each one has to be configured to work properly. Even if they are, some questions still remain:\nWill the application output have structured events (EDN, JSON, etc.) intermixed with unstructured lines (slf4j)? Will slf4j lines be send to a central location? E.g. ElasticSearch or CloudWatch? How will events from both of those libraries be consumed? Do slf4j lines have to be parsed? What if we took a different approach? Instead of configuring both libraries to use their own appenders/publishers, how about we forward slf4j events to mulog? That way we’re still dealing with slf4j events as data (not strings) and we only need to configure mulog:\nwhere to send events in what format should events be encoded How does one go about doing that? I’ll concentrate here only on routing slf4j events to mulog. Configuring mulog or bridging Java logging libaries over slf4j (log4j, JCL, JUL over slf4j) is out of scope for this post.\nWhat does it take to route slf4j events to mulog?\nMake sure slf4j and logback are added to the project dependencies. In Leiningen that would look like:\n:dependencies [,,, [org.slf4j/slf4j-api \"2.0.3\"] [ch.qos.logback/logback-classic \"1.4.4\"] ,,,] Remove any logback.xml files you might have on the classpath (e.g. resources directory). It’s not needed and will be done programatically.\nWrite the appender that will forward all events to mulog and setup the routing.\n(ns slf4j-init (:require [com.brunobonacci.mulog :as mulog]) (:import (ch.qos.logback.classic Level Logger) (ch.qos.logback.classic.spi ILoggingEvent ThrowableProxy) (ch.qos.logback.core Appender AppenderBase) (org.slf4j LoggerFactory))) (defn- new-slf4j-to-mulog-appender ^Appender [] (proxy [AppenderBase] [] (append ^void [^ILoggingEvent event] (mulog/log ::slf4j :message (.getFormattedMessage event) :logger (.getLoggerName event) :level (str (.getLevel event)) :thread-name (.getThreadName event) :exception (when-let [ex-proxy (.getThrowableProxy event)] (.getThrowable ^ThrowableProxy ex-proxy)))))) (defn setup-slf4j-to-mulog [] (let [appender (new-slf4j-to-mulog-appender) logger-context (LoggerFactory/getILoggerFactory) ^Logger root-logger (LoggerFactory/getLogger Logger/ROOT_LOGGER_NAME)] ;; Remove the default appenders that logback installs by default when no ;; logback.xml is present. See: ;; https://logback.qos.ch/manual/configuration.html#auto_configuration (.detachAndStopAllAppenders root-logger) ;; Set the default logging level for all loggers (.setLevel root-logger Level/INFO) ;; Adding appender that forwards everything to mulog. (.setContext appender logger-context) (.start appender) (.addAppender root-logger appender))) (defn stop-slf4j-to-mulog [] (let [^Logger root-logger (LoggerFactory/getLogger Logger/ROOT_LOGGER_NAME)] (.detachAndStopAllAppenders root-logger))) Execute the setup on backend service start, REPL start or before running the tests.\n(slf4j-init/setup-slf4j-to-mulog) Note that there is a different approach to this. One that doesn’t use logback-classic as a dependency. I don’t mind logback-classic, but if you do, take a look at this approach: https://gitlab.com/nonseldiha/slf4j-mulog\n","wordCount":"455","inLanguage":"en","datePublished":"2022-11-10T14:09:01+01:00","dateModified":"2022-11-10T14:09:01+01:00","author":{"@type":"Person","name":"Miro Bezjak"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mbezjak.github.io/posts/routing-slf4j-events-to-mulog/"},"publisher":{"@type":"Organization","name":"Well Organized Bits","logo":{"@type":"ImageObject","url":"https://mbezjak.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mbezjak.github.io accesskey=h title="Well Organized Bits (Alt + H)">Well Organized Bits</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=mailto:well.organized.bits@proton.me title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://mbezjak.github.io>Home</a>&nbsp;»&nbsp;<a href=https://mbezjak.github.io/posts/>Posts</a></div><h1 class=post-title>Routing Slf4j Events To Mulog</h1><div class=post-meta><span title='2022-11-10 14:09:01 +0100 +0100'>November 10, 2022</span>&nbsp;·&nbsp;Miro Bezjak&nbsp;|&nbsp;<a href=https://github.com/mbezjak/mbezjak.github.io/blob/main/content/posts/routing-slf4j-events-to-mulog.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p><a href=https://github.com/BrunoBonacci/mulog>mulog</a> plays to Clojure&rsquo;s strengths such
as declaring, using and manipulating data vs. composing and parsing strings.
That&rsquo;s why I like using it as a logging library. However, backend services might
use other Java libraries that only use what&rsquo;s available in the JVM ecosystem.
Best case scenario is that backend ends up using at least two logging libraries:
mulog and <a href=https://www.slf4j.org/>slf4j</a>. Each one has to be configured to work
properly. Even if they are, some questions still remain:</p><ul><li>Will the application output have structured events (EDN, JSON, etc.)
intermixed with unstructured lines (slf4j)?</li><li>Will slf4j lines be send to a central location? E.g. ElasticSearch or
CloudWatch?</li><li>How will events from both of those libraries be consumed? Do slf4j lines have
to be parsed?</li></ul><p>What if we took a different approach? Instead of configuring both libraries to
use their own appenders/publishers, how about we forward slf4j events to mulog?
That way we&rsquo;re still dealing with slf4j events as data (not strings) and we only
need to configure mulog:</p><ul><li>where to send events</li><li>in what format should events be encoded</li></ul><p>How does one go about doing that? I&rsquo;ll concentrate here only on routing slf4j
events to mulog. <a href=https://github.com/BrunoBonacci/mulog#publishers>Configuring</a>
mulog or <a href=https://www.slf4j.org/legacy.html>bridging</a> Java logging libaries
over slf4j (log4j, JCL, JUL over slf4j) is out of scope for this post.</p><p>What does it take to route slf4j events to mulog?</p><ol><li><p>Make sure slf4j and logback are added to the project dependencies. In
<a href=https://leiningen.org/>Leiningen</a> that would look like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span><span style=color:#e6db74>:dependencies</span> [,,,
</span></span><span style=display:flex><span>               [org.slf4j/slf4j-api <span style=color:#e6db74>&#34;2.0.3&#34;</span>]
</span></span><span style=display:flex><span>               [ch.qos.logback/logback-classic <span style=color:#e6db74>&#34;1.4.4&#34;</span>]
</span></span><span style=display:flex><span>               ,,,]
</span></span></code></pre></div></li><li><p>Remove any <code>logback.xml</code> files you might have on the classpath (e.g.
<code>resources</code> directory). It&rsquo;s not needed and will be done programatically.</p></li><li><p>Write the appender that will forward all events to mulog and setup the
routing.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#66d9ef>ns </span>slf4j-init
</span></span><span style=display:flex><span>  (<span style=color:#e6db74>:require</span>
</span></span><span style=display:flex><span>   [com.brunobonacci.mulog <span style=color:#e6db74>:as</span> mulog])
</span></span><span style=display:flex><span>  (<span style=color:#e6db74>:import</span>
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>ch.qos.logback.classic</span> Level Logger)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>ch.qos.logback.classic.spi</span> ILoggingEvent ThrowableProxy)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>ch.qos.logback.core</span> Appender AppenderBase)
</span></span><span style=display:flex><span>   (<span style=color:#a6e22e>org.slf4j</span> LoggerFactory)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>defn- </span>new-slf4j-to-mulog-appender <span style=color:#f92672>^</span>Appender []
</span></span><span style=display:flex><span>  (proxy [AppenderBase] []
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>append</span> <span style=color:#f92672>^</span>void [<span style=color:#f92672>^</span>ILoggingEvent event]
</span></span><span style=display:flex><span>      (<span style=color:#a6e22e>mulog/log</span> <span style=color:#e6db74>::slf4j</span>
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>:message</span> (<span style=color:#a6e22e>.getFormattedMessage</span> event)
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>:logger</span> (<span style=color:#a6e22e>.getLoggerName</span> event)
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>:level</span> (str (<span style=color:#a6e22e>.getLevel</span> event))
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>:thread-name</span> (<span style=color:#a6e22e>.getThreadName</span> event)
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>:exception</span> (when-let [ex-proxy (<span style=color:#a6e22e>.getThrowableProxy</span> event)]
</span></span><span style=display:flex><span>                              (<span style=color:#a6e22e>.getThrowable</span> <span style=color:#f92672>^</span>ThrowableProxy ex-proxy))))))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>defn </span>setup-slf4j-to-mulog []
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>[appender (<span style=color:#a6e22e>new-slf4j-to-mulog-appender</span>)
</span></span><span style=display:flex><span>        logger-context (<span style=color:#a6e22e>LoggerFactory/getILoggerFactory</span>)
</span></span><span style=display:flex><span>        <span style=color:#f92672>^</span>Logger root-logger (<span style=color:#a6e22e>LoggerFactory/getLogger</span> Logger/ROOT_LOGGER_NAME)]
</span></span><span style=display:flex><span>    <span style=color:#75715e>;; Remove the default appenders that logback installs by default when no</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>;; logback.xml is present. See:</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>;; https://logback.qos.ch/manual/configuration.html#auto_configuration</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>.detachAndStopAllAppenders</span> root-logger)
</span></span><span style=display:flex><span>    <span style=color:#75715e>;; Set the default logging level for all loggers</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>.setLevel</span> root-logger Level/INFO)
</span></span><span style=display:flex><span>    <span style=color:#75715e>;; Adding appender that forwards everything to mulog.</span>
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>.setContext</span> appender logger-context)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>.start</span> appender)
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>.addAppender</span> root-logger appender)))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>defn </span>stop-slf4j-to-mulog []
</span></span><span style=display:flex><span>  (<span style=color:#66d9ef>let </span>[<span style=color:#f92672>^</span>Logger root-logger (<span style=color:#a6e22e>LoggerFactory/getLogger</span> Logger/ROOT_LOGGER_NAME)]
</span></span><span style=display:flex><span>    (<span style=color:#a6e22e>.detachAndStopAllAppenders</span> root-logger)))
</span></span></code></pre></div></li><li><p>Execute the setup on backend service start, REPL start or <a href=../kaocha-start-system-hook>before running
the tests</a>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#a6e22e>slf4j-init/setup-slf4j-to-mulog</span>)
</span></span></code></pre></div></li></ol><p>Note that there is a different approach to this. One that doesn&rsquo;t use
<code>logback-classic</code> as a dependency. I don&rsquo;t mind <code>logback-classic</code>, but if you
do, take a look at this approach: <a href=https://gitlab.com/nonseldiha/slf4j-mulog>https://gitlab.com/nonseldiha/slf4j-mulog</a></p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://mbezjak.github.io>Well Organized Bits</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>