<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Avoiding Type Problems When Logging to ElasticSearch | Well Organized Bits</title><meta name=keywords content><meta name=description content="If you&rsquo;re sending your log events to ElasticSearch, you might notice that ElasticSearch sometimes fails to index some events due to type problems. A single ES index cannot contain two documents having the same key but different value types. For example, {&#34;user&#34;: 1} (integer) and {&#34;user&#34;: &#34;jane@example.com&#34;} (string) cannot be written to the same ES index.
mulog is an excellent logging library for Clojure. It can also send your events to ElasticSearch."><meta name=author content="Miro Bezjak"><link rel=canonical href=https://mbezjak.github.io/posts/avoiding-type-problems-when-logging-to-es/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://mbezjak.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mbezjak.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mbezjak.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://mbezjak.github.io/apple-touch-icon.png><link rel=mask-icon href=https://mbezjak.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Avoiding Type Problems When Logging to ElasticSearch"><meta property="og:description" content="If you&rsquo;re sending your log events to ElasticSearch, you might notice that ElasticSearch sometimes fails to index some events due to type problems. A single ES index cannot contain two documents having the same key but different value types. For example, {&#34;user&#34;: 1} (integer) and {&#34;user&#34;: &#34;jane@example.com&#34;} (string) cannot be written to the same ES index.
mulog is an excellent logging library for Clojure. It can also send your events to ElasticSearch."><meta property="og:type" content="article"><meta property="og:url" content="https://mbezjak.github.io/posts/avoiding-type-problems-when-logging-to-es/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-09T13:38:22+01:00"><meta property="article:modified_time" content="2022-11-09T13:38:22+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Avoiding Type Problems When Logging to ElasticSearch"><meta name=twitter:description content="If you&rsquo;re sending your log events to ElasticSearch, you might notice that ElasticSearch sometimes fails to index some events due to type problems. A single ES index cannot contain two documents having the same key but different value types. For example, {&#34;user&#34;: 1} (integer) and {&#34;user&#34;: &#34;jane@example.com&#34;} (string) cannot be written to the same ES index.
mulog is an excellent logging library for Clojure. It can also send your events to ElasticSearch."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://mbezjak.github.io/posts/"},{"@type":"ListItem","position":3,"name":"Avoiding Type Problems When Logging to ElasticSearch","item":"https://mbezjak.github.io/posts/avoiding-type-problems-when-logging-to-es/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Avoiding Type Problems When Logging to ElasticSearch","name":"Avoiding Type Problems When Logging to ElasticSearch","description":"If you\u0026rsquo;re sending your log events to ElasticSearch, you might notice that ElasticSearch sometimes fails to index some events due to type problems. A single ES index cannot contain two documents having the same key but different value types. For example, {\u0026quot;user\u0026quot;: 1} (integer) and {\u0026quot;user\u0026quot;: \u0026quot;jane@example.com\u0026quot;} (string) cannot be written to the same ES index.\nmulog is an excellent logging library for Clojure. It can also send your events to ElasticSearch.","keywords":[],"articleBody":"If you’re sending your log events to ElasticSearch, you might notice that ElasticSearch sometimes fails to index some events due to type problems. A single ES index cannot contain two documents having the same key but different value types. For example, {\"user\": 1} (integer) and {\"user\": \"jane@example.com\"} (string) cannot be written to the same ES index.\nmulog is an excellent logging library for Clojure. It can also send your events to ElasticSearch. How does it deal with type problems? By using name mangling. Simply put, name mangling means that for each key, mulog will append a type suffix to avoid the clash in ES. {\"user\": 1} becomes {\"user.i\": 1} and {\"user\": \"jane@example.com\"} becomes {\"user.s\": \"jane@example.com\"}. This covers almost all type problems.\nExcept there is one other case to cover. Types being different inside of a JSON arrays. Arrays themselves are mangled (having .a suffix), but the primitive values inside the array are not. Consider the following two documents {:users [1 2 3]} (array of integers) and {:users [\"jane@example.com\" \"john@example.com\"]} (array of strings). ES will refuse to index the subsequent document due to a type problem. Mulog might not be in the best place to solve this problem because it doesn’t know anything about how you intend to use this data. So, how to solve this problem anyway? There are a few ways that come to mind:\nRename the keys. E.g. use :user-ids and :user-emails instead of :users Eliminate the array from being logged. E.g. (dissoc event :users) (str v) all the values inside of an array to make sure that they have the same type. Use a different mulog index. E.g. use a different :index-pattern for each event type. Those solutions have different trade-offs to consider. I usually don’t use primitive array values in Kibana, but like having them be a part of the same event because sometimes it simplifies debugging. So far, solution no. 3. worked well for me. Here is what that could look like.\nmulog_init.clj\n(ns mulog-init (:require [clojure.walk :as walk] [com.brunobonacci.mulog.utils :as mulog.utils])) (defn- transform-elasticsearch-types [events] (walk/postwalk (fn [c] (cond ;; ES doesn't like it when array element type changes. (or (seq? c) (set? c) (and (vector? c) (not (map-entry? c)))) (map (fn [x] (if (or (number? x) (boolean? x)) (str x) x)) c) ;; com.brunobonacci.mulog.publishers.util/type-mangle mangles only ;; Exceptions, not any Throwable. This creates type problems (oh the ;; irony) in ES: ;; 1. Exception is encoded as `{\"exception\": {\"x\": \"exception stack trace\"}}` ;; 2. Throwable is encoded as `{\"exception\": \"exception stack trace\"}` ;; This of course cannot work. \"exception\" must either be an object or a string. ;; https://github.com/BrunoBonacci/mulog/issues/98 ;; Here until v0.10.0 comes out. ;; https://github.com/BrunoBonacci/mulog/blob/master/CHANGELOG.md (instance? Throwable c) (mulog.utils/exception-stacktrace c) :else c)) events)) Using the transformer.\n(mulog/start-publisher! {:type :elasticsearch :transform mulog-init/transform-elasticsearch-types :url ,,,}) ","wordCount":"461","inLanguage":"en","datePublished":"2022-11-09T13:38:22+01:00","dateModified":"2022-11-09T13:38:22+01:00","author":{"@type":"Person","name":"Miro Bezjak"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://mbezjak.github.io/posts/avoiding-type-problems-when-logging-to-es/"},"publisher":{"@type":"Organization","name":"Well Organized Bits","logo":{"@type":"ImageObject","url":"https://mbezjak.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mbezjak.github.io accesskey=h title="Well Organized Bits (Alt + H)">Well Organized Bits</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://mbezjak.github.io/archives/ title=Archive><span>Archive</span></a></li><li><a href=mailto:well.organized.bits@proton.me title=Contact><span>Contact</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://mbezjak.github.io>Home</a>&nbsp;»&nbsp;<a href=https://mbezjak.github.io/posts/>Posts</a></div><h1 class=post-title>Avoiding Type Problems When Logging to ElasticSearch</h1><div class=post-meta><span title='2022-11-09 13:38:22 +0100 +0100'>November 9, 2022</span>&nbsp;·&nbsp;Miro Bezjak&nbsp;|&nbsp;<a href=https://github.com/mbezjak/mbezjak.github.io/blob/main/content/posts/avoiding-type-problems-when-logging-to-es.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>If you&rsquo;re sending your log events to
<a href=https://www.elastic.co/elasticsearch/>ElasticSearch</a>, you might notice that
ElasticSearch sometimes fails to index some events due to type problems. A
single ES index cannot contain two documents having the same key but different
value types. For example, <code>{"user": 1}</code> (integer) and <code>{"user": "jane@example.com"}</code> (string) cannot be written to the same ES index.</p><p><a href=https://github.com/BrunoBonacci/mulog>mulog</a> is an excellent logging library
for Clojure. It can also
<a href=https://github.com/BrunoBonacci/mulog/blob/master/doc/publishers/elasticsearch-publisher.md>send</a>
your events to ElasticSearch. How does it deal with type problems? By using name
mangling. Simply put, name mangling means that for each key, mulog will
<a href=https://github.com/BrunoBonacci/mulog/blob/0.9.0/mulog-elasticsearch/src/com/brunobonacci/mulog/publishers/util.clj#L31>append</a>
a type suffix to avoid the clash in ES. <code>{"user": 1}</code> becomes <code>{"user.i": 1}</code>
and <code>{"user": "jane@example.com"}</code> becomes <code>{"user.s": "jane@example.com"}</code>.
This covers almost all type problems.</p><p><strong>Except</strong> there is one other case to cover. Types being different inside of a
JSON arrays. Arrays themselves are mangled (having <code>.a</code> suffix), but the
primitive values inside the array are not. Consider the following two documents
<code>{:users [1 2 3]}</code> (array of integers) and <code>{:users ["jane@example.com" "john@example.com"]}</code> (array of strings). ES will refuse to index the subsequent
document due to a type problem. Mulog might not be in the best place to solve
this problem because it doesn&rsquo;t know anything about how you intend to use this
data. So, how to solve this problem anyway? There are a few ways that come to
mind:</p><ol><li>Rename the keys. E.g. use <code>:user-ids</code> and <code>:user-emails</code> instead of <code>:users</code></li><li>Eliminate the array from being logged. E.g. <code>(dissoc event :users)</code></li><li><code>(str v)</code> all the values inside of an array to make sure that they have the
same type.</li><li>Use a different mulog index. E.g. use a different <code>:index-pattern</code> for each
event type.</li></ol><p>Those solutions have different trade-offs to consider. I usually don&rsquo;t use
primitive array values in Kibana, but like having them be a part of the same
event because sometimes it simplifies debugging. So far, solution no. 3. worked
well for me. Here is what that could look like.</p><p><code>mulog_init.clj</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#66d9ef>ns </span>mulog-init
</span></span><span style=display:flex><span>  (<span style=color:#e6db74>:require</span>
</span></span><span style=display:flex><span>   [clojure.walk <span style=color:#e6db74>:as</span> walk]
</span></span><span style=display:flex><span>   [com.brunobonacci.mulog.utils <span style=color:#e6db74>:as</span> mulog.utils]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>(<span style=color:#66d9ef>defn- </span>transform-elasticsearch-types [events]
</span></span><span style=display:flex><span>  (<span style=color:#a6e22e>walk/postwalk</span>
</span></span><span style=display:flex><span>   (<span style=color:#66d9ef>fn </span>[c]
</span></span><span style=display:flex><span>     (<span style=color:#a6e22e>cond</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; ES doesn&#39;t like it when array element type changes.</span>
</span></span><span style=display:flex><span>       (or (seq? c)
</span></span><span style=display:flex><span>           (<span style=color:#a6e22e>set?</span> c)
</span></span><span style=display:flex><span>           (and (vector? c) (not (<span style=color:#a6e22e>map-entry?</span> c))))
</span></span><span style=display:flex><span>       (map (<span style=color:#66d9ef>fn </span>[x]
</span></span><span style=display:flex><span>              (<span style=color:#66d9ef>if </span>(or (<span style=color:#a6e22e>number?</span> x) (<span style=color:#a6e22e>boolean?</span> x))
</span></span><span style=display:flex><span>                (str x)
</span></span><span style=display:flex><span>                x))
</span></span><span style=display:flex><span>            c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; com.brunobonacci.mulog.publishers.util/type-mangle mangles only</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; Exceptions, not any Throwable. This creates type problems (oh the</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; irony) in ES:</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; 1. Exception is encoded as `{&#34;exception&#34;: {&#34;x&#34;: &#34;exception stack trace&#34;}}`</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; 2. Throwable is encoded as `{&#34;exception&#34;: &#34;exception stack trace&#34;}`</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; This of course cannot work. &#34;exception&#34; must either be an object or a string.</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; https://github.com/BrunoBonacci/mulog/issues/98</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; Here until v0.10.0 comes out.</span>
</span></span><span style=display:flex><span>       <span style=color:#75715e>;; https://github.com/BrunoBonacci/mulog/blob/master/CHANGELOG.md</span>
</span></span><span style=display:flex><span>       (instance? Throwable c)
</span></span><span style=display:flex><span>       (<span style=color:#a6e22e>mulog.utils/exception-stacktrace</span> c)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>       <span style=color:#e6db74>:else</span> c))
</span></span><span style=display:flex><span>   events))
</span></span></code></pre></div><p>Using the transformer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-clojure data-lang=clojure><span style=display:flex><span>(<span style=color:#a6e22e>mulog/start-publisher!</span>
</span></span><span style=display:flex><span> {<span style=color:#e6db74>:type</span> <span style=color:#e6db74>:elasticsearch</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:transform</span> mulog-init/transform-elasticsearch-types
</span></span><span style=display:flex><span>  <span style=color:#e6db74>:url</span> ,,,})
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://mbezjak.github.io>Well Organized Bits</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>